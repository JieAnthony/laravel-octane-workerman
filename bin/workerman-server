#!/usr/bin/env php
<?php

use Laravel\Octane\ApplicationFactory;
use Laravel\Octane\RequestContext;
use Laravel\Octane\Worker;
use JieAnthony\LaravelOctaneWorkerman\Workerman\WorkermanClient;
use Workerman\Connection\ConnectionInterface;
use Workerman\Worker as WorkermanWorker;
use Workerman\Connection\TcpConnection;
use Workerman\Protocols\Http\Request;

ini_set('display_errors', 'on');
error_reporting(E_ALL);

$basePath = require $_SERVER['APP_BASE_PATH'] . '/vendor/laravel/octane/bin/bootstrap.php';

$data = json_decode(file_get_contents($_SERVER['argv'][2]), true);
$daemon = $data['state']['daemon'];
$publicPath = $data['state']['publicPath'];
$octaneConfig = $data['state']['octaneConfig'];
$config = $octaneConfig['workerman'] ?? $octaneConfig['gatewayworker'];
$httpConfig = $config['http'];

define('MAX_REQUEST', (int)$data['state']['maxRequests']);

date_default_timezone_set($data['state']['timezone']);

WorkermanWorker::$onMasterReload = function () {
    if (function_exists('opcache_get_status')) {
        if ($status = opcache_get_status()) {
            if (isset($status['scripts']) && $scripts = $status['scripts']) {
                foreach (array_keys($scripts) as $file) {
                    opcache_invalidate($file, true);
                }
            }
        }
    }
};

WorkermanWorker::$pidFile = $httpConfig['pid_file'];
WorkermanWorker::$stdoutFile = $httpConfig['stdout_file'];
WorkermanWorker::$logFile = $httpConfig['log_file'];
WorkermanWorker::$daemonize = $daemon;
TcpConnection::$defaultMaxPackageSize = $httpConfig['max_package_size'] ?? 10 * 1024 * 1024;

if ($httpConfig['enable']) {
    $workerman = new WorkermanWorker("http://{$data['state']['host']}:{$data['state']['port']}", $httpConfig['context'] ?? []);

    $workerman->count = $httpConfig['count'] ?: cpu_count() * 2;
    $workerman->name = $httpConfig['name'];
    $workerman->user = $httpConfig['user'];
    $workerman->group = $httpConfig['group'];
    $workerman->reusePort = $httpConfig['reuse_port'];
    $workerman->transport = $httpConfig['transport'];

    $worker = null;
    $workermanClient = new WorkermanClient;

    $workerman->onMessage = function (ConnectionInterface $connection, Request $workermanRequest) use (
        $worker,
        $workermanClient,
        $basePath,
        $publicPath,
        $octaneConfig,
    ) {
        static $request_count = 0;

        try {
            /** @var Worker $worker */
            $worker = tap((new Worker(
                new ApplicationFactory($basePath), $workermanClient
            )))->boot();

        } catch (Throwable $e) {
            $connection->send($e->getMessage());

            exit(1);
        }

        [$request, $context] = $workermanClient->marshalRequest(new RequestContext([
            'workermanRequest' => $workermanRequest,
            'connection' => $connection,
            'publicPath' => $publicPath,
            'octaneConfig' => $octaneConfig,
        ]));

        $worker->handle($request, $context);

        if (++$request_count >= MAX_REQUEST) {
            WorkermanWorker::stopAll();
        }
    };
}

// Windows does not support custom processes.
if (\DIRECTORY_SEPARATOR === '/') {
    $process = $config['process'] ?? [];
    foreach ($process as $process_name => $config) {
        if ($config['enable'] ?? false) {
            worker_start($process_name, $config);
        }
    }

    foreach (webman_config('plugin') ?? [] as $firm => $projects) {
        foreach ($projects as $name => $project) {
            foreach ($project['process'] ?? [] as $process_name => $config) {
                if ($config['enable'] ?? false) {
                    worker_start("plugin.$firm.$name.$process_name", $config);
                }
            }
        }
    }
}

WorkermanWorker::runAll();
